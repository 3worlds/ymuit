= Organisation of 3Worlds java projects: technical documentation for 3Worlds developers
Jacques Gignoux <jacques.gignoux@upmc.fr>; Ian D. Davies <ian.davies@anu.edu.au>
//v1.0, 15 October 2018:
//v1.1, 5 November 2018:
v1.2, 26 November 2018:
:sectnums:
:toc: left

by *{author}* & *{author_2}*

Version: *{revnumber}* ({revdate})

WARNING: *Please read this document in full before attempting contributions to 3Worlds.*

== Overview

//The code needed to run 3Worlds is organised in autonomous pieces of software that could be re-used as _libraries_ by others. It also relies on 3^rd^ party libraries developed by others and following their own path of development. To manage these dependencies reliably, we use http://ant.apache.org/ivy[ivy].

This document describes how to setup a working environment to contribute to 3Worlds. The 3Worlds codebase is organised as a set of automomous reuseable projects, referred to here as _libraries_. 3Worlds library development follows a particular set of guidelines. We use http://ant.apache.org/ivy[ivy] to handle dependency management and the *eclipse* integrated development environment (IDE). We assume some familiarity with the  *eclispe* IDE.

=== 3Worlds libraries

Currently, the 3Worlds project has produced the following libraries:

omhtk:: *omhtk* stands for _One More Handy Tool Kit_ and is a library of generic, very low-level interfaces (e.g. `Sizeable` for a class which instances have a size, `Named` for classes which instances have a name, etc...) plus very commonly used utilities people keep rewriting all the time (e.g. an euclidian distance function or a time conversion method). Almost all other 3Worlds libraries depend on this one.
// yatk - yet another tool kit - should it be twcommons?

omugi:: *omugi* stands for _One More Graph Implementation_. It implements classes to represent dynamic graphs. It depends on *omhtk*. 
// why not omgi ? anyway, new c compliers are usually cally yacc - yet another c compiler.

uit:: *uit* stands for _Universal Indexing Tree_. It implements classes to to provide efficient searching of spatial data. The base class is an `IndexingTree`. It is a generalisation of a https://en.wikipedia.org/wiki/Quadtree[QuadTree], more accurately called a https://en.wikipedia.org/wiki/K-d_tree[_k_-d tree]. It is based on work by *Paavo Toivanen* found https://dev.solita.fi/2015/08/06/quad-tree.html[here].

[more to come]:: ...

=== Library organisation

All 3Worlds libraries _must_ adhere to the following directory structure:
----
<library_name>
    src            // the .java source files and only them
    test           // the test .java source files
    bin            // the .class binary files
    doc            // all the documentation-related files excluding javadoc
    lib            // downloaded .jar dependecies
    scripts        // dependency and versioning scripts
    javadoc        // generated javadoc files
    resources      // all non java files required to run the code
----

Each library is stored in a *git* repository. In other words, libraries are units of packaging for software distribution. However, not all the directories listed above should be are stored in the git repositories as they are generated by the IDE. These are:

* `bin`
* `lib`

In addition, the following directories are optional:

* `resources`
* `test`

//Although it is highly recommended _not_ to distribute a library without testing, it may happen for particularly low-level ones (_e.g._ pure interface libraries) that no test code can be written for them. 
// I think it can be assuemed that code must be tested.

=== Development tools

* The code is written in https://www.java.com/[java] *8*.
* These instructions are written for the https://www.eclipse.org/ide/[eclipse] IDE (version 2018-09).
* Code testing uses https://junit.org/junit5/[JUnit].
* Application interfaces use https://wiki.openjdk.java.net/display/OpenJFX[javafx], extended with http://fxexperience.com/controlsfx/[controlsFx].
* The documentation is written with https://asciidoctor.org/[asciidoctor] https://marketplace.eclipse.org/content/asciidoctor-editor[editor for eclipse]. Asciidoctor enables production of  *html*, *pdf* and *man* pages from the same source. You may find the following editors useful: https://asciidocfx.com/[AscidocFX], https://asciidoclive.com[AsciiDocLIVE] and the asciidoctor editor found on the eclipse MarketPlace.
* Dependency management is based on http://ant.apache.org/ivy[ivy] and https://ant.apache.org/[ant].
* Library repositories are managed with https://git-scm.com/[git], with the requirement that _1 library = 1 git repository_.

The development tools required are:

* *git*
* *asciidoctor*
* *eclipse*, including 
** support for *ivy* and *ant* (but that should come as a default when installing eclipse)
** the https://marketplace.eclipse.org/content/egit-git-integration-eclipse[egit] plugin for eclipse, found on the eclipse MarketPlace

== Working on existing 3Worlds libraries

To work on an existing library (_<library>_ from hereon):

. Launch *eclipse*. Open a workspace or create a new workspace with a name of your choice (_<workspace>_ from hereon).

. If the Welcome window opens (the default), disable the `Always show Welcome at start up` checkbox and close the Welcome window (this option causes problems with the editor behaviour in some versions of eclipse).

. Shift to the Git perspective. You should now have a left window called `Git repositories`.

. In this window, click on `Clone a Git repository`. 3Worlds is currently hosted by two gitlab servers: 

* at https://grouper.ent.upmc.fr/gitlab/threeWorlds[Sorbonne Universit√© (SU)] in Paris, France
* at the https://gitlab.anu.edu.au/ThreeWorlds[Australian National University (ANU)] in Canberra, Australia

* These central repositories are managed by Jacques Gignoux ({email}) or Ian Davies ({email_2}). Ask them for an access to one of these servers. In the `URI:` field, enter one of:

** `git@grouper.ent.upmc.fr:threeWorlds/_<library>_.git` for SU

** `git@gitlab.anu.edu.au:ThreeWorlds/_<library>_.git` for ANU

. Click `Next`. 

. Click `Next` again. Enter the location for your local git repository. The default location is usually a _git_ directory under the user home.  

WARNING: Do *not* put the git repository inside the eclipse workspace, as this will cause trouble later.

. Click `Finish`. After the download completes, a new entry will appear in the `Git repository` window. If this fails, check your access to the remote repository.

. Expand the git repo by clicking on the black arrow on its left. This displays a list of items found in this project. In this list, expand the _Working Tree_ entry. This should display a list of two entries, _.git_ and _<library>_.

. Right-click on _<library>_ and select `JavaImport Projects...`. In the dialog box, click `Finish`. NOTE: in older versions of eclipse, the new project may not be properly recognized. Upgrade eclipse if this happens.

. Shift to the java perspective: the project contained in the local git repository is now present in the Package Explorer window, usually with many error messages.

To remove the errors, add the following libraries to **_<library>_**:

. *JUnit*:
* Right-click on the project and select `Build Path > Add Libraries...`
* In the dialog box, select _JUnit_ and click `Next`
* Select version 5 of JUnit and click `Finish`
+
This should remove the error icon on the _test_ folder.

. *Ivy*:
* Again, right-click on the project and select `Build Path > Add Libraries...`
* In the dialog box, select _IvyDE Managed Dependencies_ and click `Next`
* In the top field, replace `ivy.xml` by `scripts/ivy.xml` and click `Finish`
* Click `Apply and Close`
+
This should remove errors in the _src_ folder.

If errors remain, it means the _ivy_ local cache does not contain required dependencies of this library. To solve this see <<Trouble shooting>>.
////
. Check in _<library>/scripts/ivy.xml_ the list of dependencies and identify the local ones, ie those that are other 3Worlds libraries

. Clone these libraries as new projects into your workspace as specified just above.

. You may need to refresh _<library>_ or to re-run its _build.xml_ script by hand:
* First check your eclipse installation details. You must have `Apache Ivy Ant Tasks` as well as the other Apache Ivy plugins.
* Right-click on _scripts/build.xml_ and select `Run As > 2 Ant Build...`  (the second entry, not the first). 
* In the opening dialog box, select the `resolve` task and click `Run`. Things should happen in the console window and hopefully terminate like this:
----
...
BUILD SUCCESSFUL
Total time: 667 milliseconds
----
////

== Developing a new library for 3Worlds

This section describes how to create a new 3Worlds library in **eclipse**. If you plan to work on _existing_ 3Worlds code, see instructions in section <<Working on existing 3Worlds libraries>>.

Before proceeding, check you have a copy of _VersionManger.java_ that should accompany this document. If not, ask the main developers ({email}) or Ian Davies ({email_2})).


Once you have decided on a name for your library (_<library>_ from hereon), proceed as follows:

=== java project

. Launch *eclipse* and follow the first two steps in the section: <<Working on existing 3Worlds libraries>>. 
. Create a new Java Project: 
* In the top menu, select `File > New > Java Project`.
* Enter a project name (_<library>_) and click `Finish`.

=== directory structure

In the project, create the directory structure for your library:

. in the `Package Explorer` window (usually on the left), right-click on your project name and select `New > Source Folder`
. in the opening dialog box, enter **_test_** and click Finish
. repeat this step to create the source folder **_scripts_**
. then create _non-source_ folders **_resources_** and **_doc_** but this time selecting `New > Folder` rather than `New > Source Folder`.

[IMPORTANT]
====
It is important to create the correct type of folders (**_source_** or  **_non-source_**). You can delete and recreate folders if you make a mistake.
====

We recommend that you store this file in the _doc_ folder for further consultation during the development of your library (for example under a sub-folder
called _dev_, for __dev__elopment). 

=== version and dependency management

To setup the version management:

. Select folder _scripts_. Right-click on it to create a package (`File > New > Package`) and 
name it **_fr.cnrs.iees.versioning_** when prompted. Click `Finish`.

. Now import the file **_VersionManager.java_** into this folder. 
* Right-click on the _scripts/fr.cnrs.iees.versioning_ package and select `Import...`
* In the dialog box, expand the `General` entry and select `File System`
* Click `Next`
* Click the `Browse` button facing the `From Directory` label and field.
* In the dialog box, select the *directory* where your files to import are located.
* The dialog box should now display the directory tree on the left and a list of files on the right. Select **only** _VersionManager.java_ from this list.
* Click `Finish`. _VersionManager.java_ should now appear under  _scripts/fr.cnrs.iees.versioning_ with no visible error.

. To modify _VersionManager.java_ to match the details of your _<library>_:
* Double-click on the file name. It should open in the eclipse java editor window.
* Carefully read the instructions given in the javadoc comment of the class (if you're familiar with hieroglyphics).
* Modify as instructed the following fields (at the top of the class code): `_ORG_`, `_MODULE_`,`_STATUS_`,`_LICENSE_`,`__LICENSE_URL__`,`_DESCRIPTION_`, and `_DEPS_` if required. In the `_DEPS_` field you can provide a list of dependencies for both 3^rd^ party and 3Worlds libraries. If you have no dependencies leave this entry empty. *NOTHING ELSE* should to be changed in this file.

+
It is important to take some time to properly edit this file, as these fields will be used for versioning the whole library. Once versioning is started, this file should not be edited again (in a unix-derived OS, it is a good idea to set this file permissions to read-only once this step is fulfilled). **Wondering, at this time, how you add dependencies later?**.

. You can now run `VersionManager.main()` with no argument on the command line. In eclipse: 
* in the `Package Explorer` window, right-click on the class, select `Run As > Java Application`.
* The console window in eclipse should now display: 
+
----
Upgrading "<library>" from version 0.0.0 to version 0.0.1 (Y/n)? 
----
Enter 'Yes'. You get this message in the console: 
+
----
Project scripts regenerated - Do not forget to refresh your eclipse workspace before going on.
----
* As suggested, refresh your project (F5 on the project name). You should now see three new files in the `Package Explorer`:
_scripts/fr.cnrs.iees.versioning/current_version.txt_:: This file holds the current version of your library (0.0.1 in this case). **Do not** edit by hand: it is entirely managed by `VersionManager`.
_scripts/ivy.xml_:: This file is the ivy script needed by eclipse to manage dependencies of your library on other libraries.
_scripts/build/xml_:: This file is the ant script needed by eclipse to manage dependencies _and_ enabling you to pack your library into a jar file with proper versioning information for distribution.
+
Since these scripts are generated they should never be edited by hand (because edits would be lost at the next version upgrade). 

// So what happens when you have to add some new dependencies

. For eclipse to know about your dependency management, you must now tell it where to find ivy scripts:
* Right-click on project _<library>_ and select `Properties`
* Select `Build Path > Add Libraries...`
* In the dialog box, select `IvyDE Managed Dependencies`. Click `Next`
* In the top field, replace `ivy.xml` by `scripts/ivy.xml` and click `Finish`
* Right click on the _build.xml_ file and select `Run as > 2 Ant build...`. Check the _publishJar_ task and click _run_.
* Select the _<library>_ and press `F5` to refresh your project.
// you need to do this to create the lib dir (unless there was some option to do this automatically somewhere else)

+ 
Your project should now be ready to use the dependencies as listed in its (generated)  _ivy.xml_ file. If you look at your project (_<library>_) in the Package Explorer, you will see a _lib_ directory which contains all the downloaded dependecy jars, if in fact, you did list some dependencies and other files. This is why _lib_ should not be managed by *git*: it is generated by eclipse.

=== local git repository for a new library

As your library is new, nobody knows about it and you should create a new git repository from scratch. This will later pushed up stream to a common (eg github or gitlab) server for sharing the library.

Before proceeding, make sure your git user.name and user.email on your local system are as you will be known on your proposed git server. Check the current setting by typing in a terminal `git config --list`.
----
 Set your username: `git config --global user.name "PRENOM NOM"`
 Set your email address: `git config --global user.email "Berger@example.com"`
----

. In eclipse, shift to the Git perspective. You should now have a left window called `Git repositories`.

. In this window, click on `Create a new local Git repository`. When prompted, enter a path where you want this repository to be located stay on your hard disk (_<git-repo>_ from hereon) and click `Create`. You should now see a new entry in the `Git repository` window.

+
IMPORTANT: Do *not* put the git repository inside the eclipse workspace, as this will cause trouble later. Rather, use the default location (usually a _git_ directory under the user home).

. Now go back to the Java perspective. Right-click on your project, select `Team > Share Project...`. In the dialog box, select _<git-repo>_ in the `Repository:` list and click `Finish`. Your project is now managed by git.

. Files in the project now have a small question mark attached on their icon. This means they are not yet tracked by git. To track files:

* Right-click on **_<library>_** and select `Team > Commit...`
* The `Git staging` lists a number of files with 'unstaged changes' (you may need to scroll to see all these entries). Some versions of *eclipse* may differ slightly in appearance.
* A number of files are listed from the _lib_ directory. We first need to exclude this entire directory (The **eGit** UI does not allow this intuitively).  Double click on `.gitignore - _<library>_`. 
** In the `Local:.gitignore` you will see `/bin/`. This was added automatically during the previous steps. Add a new line with `/lib/`.

** Add another new line with `/.settings/`

** Click the "X" to close this window and select `Save` when prompted. Files in the _lib_ and _.settings_ directories are now removed from the `Unstaged Changes` list. Below, `<ORG>` represents the string you added previously to the `VersionManager.java` file. 

** _.classpath -<library>_
** _.gitignore -<library>_
** _.project -<library>_
** _3w-projects-setup.adoc - <library>/doc/dev_
** _build.xml - <library>/scripts_
** _current-version.txt - <library>/scripts/<ORG>_
** _ivy.xml - <library>/scripts_
** _VersionManager.java - <library>/scripts/<ORG>_

* There are two more files to remove from tracking - **_.classpath_** and **_.project_**. Select these two files (Ctrl + Mouse for multiple selection). Right-click on them and select `Ignore`. It is important not to track, and therefore share, these files as they represent local eclipse settings. If you open _.gitignore_ as before, you will see that these files have been added to the list of untracked files together with the above mentioned directories.
* You can now move the remaining files to the staged list by clicking on the green double 'plus' sign at the top right of the window
* Enter a commit message (e.g. "Initial commit") in the right panel and click `Commit`. Your files are now stored in your local git repository.

=== remote git repository for your new library


Before you can share your new library with others, you must create a git repository for it on a shared server. 3Worlds is currently hosted by two gitlab servers: 

* at https://grouper.ent.upmc.fr/gitlab/threeWorlds[Sorbonne Universit√©] in Paris, France
* at the https://gitlab.anu.edu.au/ThreeWorlds[Australian National University] in Canberra, Australia

To create a new git repository on one of these servers, contact either Jacques Gignoux ({email}) or Ian Davies ({email_2}). Once you have an account you can either create a project from that account or create a project remotely and push it up stream to that account. Here we will do the former.

. Log in to your account on the server and create a project, here called **_<library>_**. 
 
. You may want to switch off `pipeline` processing for the newly created project unless you are sure you want this facility.

. Once the project is set up, copy its URL. This will be of the form `git@<host>:<account name>/<project name>

. Back in eclipse, right-click on **_<library>_** and select `Team > Push Branch 'master'`

. The  first time you do this, eclipse opens a dialog box to enter the remote git repository details:
* Leave the `Remote name` as `origin`
* In the `URI:` field, paste URI of your remote repository. This has the form as given above.
* Click `Preview`
* Click `Preview` again
* Click `Push`
* Click `Close`
// URL was git@gitlab.anu.edu.au:u9007333/testdoco.git not 

== Versioning

By versioning here we mean generating and managing meaningful version numbers for your library for distribution. This is _completely independent_ from git version management.

=== aim and strategy

Every 3Worlds library has a 3-number-separated-by-dots version identifier. The three values represent MAJOR, MINOR and BUILD numbers. Deciding when and which value to increment is somewhat subjective. However, to try and maintain some consistency we suggest the following:

. **BUILD**: This number should be increased when a bug, or suite of related bugs, has been fixed and tested.
. **MINOR**: This number should be increased: (i) when a large refactoring has taken place; (ii) when new functionality has been implemented and is still undergoing testing; and, (iii) when important changes in 3^rd^ party dependencies flow through to significant changes in the code.
. **MAJOR**: This number should be at 1 when software is first publicly distributed. Thereafter, this number should be increased only when very significant new functionality has been added, tested and been found stable (e.g. a new GUI or integration with OpenMole).


=== method / how to

IMPORTANT: **To avoid version conflicts, discuss the version increament with colleagues and decide who is to be responsible for making the version change. This is critical, as version changes are difficult to undo, especially when pushed to the central server.**

Version numbers are incremented by running `VersionManager.main()` (in package _scripts/fr.cnrs.iees.versioning_) with the **appropriate command-line argument**: 

.. **BUILD**: no argument; 
.. **MINOR**: `-minor` argument (this will reset the BUILD number to 0); or
.. **MAJOR**: `-major` argument (this will reset the MINOR _and_ BUILD numbers to 0).

To pass arguments on the command line, you must create a _Run Configuration_ (Main menu: `Run > Run Configurations...` etc. cf. the eclipse documentation for how to create run configurations) and then execute it.

. Once you are clear about how to use the appropriate argument, run the _VersionManager_.  The console window in eclipse should now display: 
+
----
Upgrading "<library>" from version <M.m.b> to version <N.n.c> (Y/n)? 
----
+
Enter 'Y'. You then get this message in the console: 
+
----
Project scripts regenerated - Do not forget to refresh your eclipse workspace before going on.
----
. As suggested, refresh your **_<library>_** (F5 on the project name). 
+
You should now see two new files in the `Package Explorer`:

_scripts/fr.cnrs.iees.versioning/ivy-<M.m.b>.xml_:: This is a copy of the former _ivy.xml_, suffixed with the previous version identifer, for archive. 

_scripts/fr.cnrs.iees.versioning/build-<M.m.b>.xml_:: This is a copy of the former _build.xml_, suffixed with the previous version identifer, for archive. 

+
The files _scripts/ivy.xml_, _scripts/build.xml_ and _scripts/fr.cnrs.iees.versioning/current-version.txt_
have also been rewritten to match the new version identifer.

. Right-click on _scripts/build.xml_ and select `Run As > 2 Ant Build...`  (the second entry, not the first). In the opening dialog box, select the `publishJar` task and click `Run`. Things should happen in the console window and hopefully terminate like this:
+
----
...
[ivy:publish] 	published <library> to /home/gignoux/.ivy2/local/fr.ens.biologie/<library>/0.0.2/jars/<library>.jar
[ivy:publish] 	published ivy to /home/gignoux/.ivy2/local/fr.ens.biologie/<library>/0.0.2/ivys/ivy.xml
BUILD SUCCESSFUL
Total time: 667 milliseconds
----

If you look into your _ivy_ cache (_.ivy2/local/_ in your home directory), you should now have a new
sub-directory with a new version number (e.g. 0.0.2 here):
----
fr.ens.biologie
  <library>
    0.0.1
      ivys
        ivy.xml
        ivy.xml.md5
        ivy.xml.sha1
      jars
        <library>.jar
       	<library>.jar.md5
        <library>.jar.sha1
    0.0.2
      ivys
        ivy.xml
        ivy.xml.md5
        ivy.xml.sha1
      jars
        <library>.jar
        <library>.jar.md5
        <library>.jar.sha1
----
// Plus, a new directory _lib_ in your java project should contain a new _<library>.jar_ file with its fellow _ivy.xml_ file.
// lib is already there in section adding dir to .gitignore

All versioning information in _scripts/fr.cnrs.iees.versioning_ is stored in the git repository.
_VersionManager_ archives the former versioning information as _build.xml_ and _ivy.xml_ files suffixed with 
the version numbers. 

However, what is _not_ archived is the state of the code at the time of version update: the development will go on happily and the changes will fade in the mists of the past...! If we want to be able to go back to a former version, we need to tell git about this version. This is simply done by using the 
https://git-scm.com/book/en/v2/Git-Basics-Tagging[_tagging_] capacity of git.

So, *just after a version upgrade* as explained above, and *before doing anything else* (e.g. routinely editing code), you *must*:

. Prepare the commit of the files created by the version upgrade (just after a version update, you have changed many files in the _scripts_ folder): 
* Go to the `Git Staging window in the java perspective (if you don't find it, right-click on project name and select
`team > Commit...`. This will open it)
* Add all the files appearing in _Unstaged Changes_ to _Staged Changes_ by clicking on the double green plus in the top
right corner of the window
* Write a commit message (for example: _"upgrading to version <N.n.c>"_)
* Click `Commit` (*NOT* `Commit and Push...`)

. Set a git tag on this commit:
* In the Package Explorer window, right-click on the project name, select `Team > Advanced > Tag...`
* In the opening dialog box, enter the new version number you have just upgraded to (<N.n.c>) in the `Tag name:` field
* In the `Tag message:` field, enter some description of this version change. Something meaningful and useful, e.g. 'fixed bug #543458754' for a BUILD change, 'refactored Query system' for a MINOR change, or 'added parallel execution support' for a MAJOR change.

. Push the change to the remote git repository:
* Click `Create Tag and Start Push...`
* In the opening dialog box, check that the proper tag is associated to the proper commit and click `Next`
* Click `Finish`
* Click `Close`

WARNING: Good coordination between developers is very important in ensureing these versioning operations go smoothly. Git is very permissive about tagging in remote repository (by default, tags are not pushed, and they can be easily overwritten).
So please be careful.
// Impressive! well done!

== Managing dependencies

It is easy to manage the dependency between your library and other software with _ivy_: you just have to add the appropriate dependency details in your _ivy.xml_ file. However, since we generated this file, you must actually do it in the _VersionManager.java_ class. This is just as easy: you add them into your `_DEPS_` static field (see the comments associated with this field in _VersionManger.java_). It is a good idea to set the revision identifier to `"+"` so that your library always uses the last version of the software.

In principle, eclipse is able to manage dependencies based on the _ivy_ script. However, there are sometimes problems emerging at version upgrades of dependencies. If you experience problems (e.g., `Class not found` error messages for a class belonging to a library you have declared in your dependency list), you may try one of these solutions:
// maybe move to Trouble shooting section?

. In the Package Explorer window, right-click on `Ivy scripts.ivy.xml` and select `Clean all caches`. This erases the _cache_ directory in the _~/.ivy2_ directory, but not the _local_ directory where the dependencies on local libraries (those of your projects) reside.

. In the Package Explorer window, right-click on `Ivy scripts.ivy.xml` and select `Remove Ivy dependency management...`

If errors persist, then it may be worth doing a complete clean of the dependencies:

. Go to your _.ivy2_ repository, delete everything (i.e. _cache_ and _local_)
. Remove _ivy_ from your project libraries (through `Project > Properties > Java build Path`). This should in principle (there seem to be display bugs - or maybe you have to use Refresh all the time) remove the `Ivy scripts/ivy.xml` entry from your Package Explorer. 
. Reconstruct all your local dependencies (starting from the top of the tree and following its branches in order) by running the _build.xml_ _publishJar_ task as explained in <<Versioning>>
. Reload the _ivy.xml_ dependencies by right-clicking on _ivy.xml_ and selecting the `Add Ivy Library...` entry in the pop-up menu. This should reconstuct the proper list of jars under the `Ivy scripts/ivy.xml` entry in your Package Explorer.

== Licensing

// Just a suggestion that we could use project specific code templates for this. This, at least has the benefit of being more common practice?

All work on 3Worlds libraries is distributed as free software under the https://www.gnu.org/licenses/gpl-3.0.en.html[GNU General Public license version 3]
(GPL.3) license. Every source file of 3Worlds libraries must contain a header with a reference to the GPL.3 and the full text of the license must be present in the distributed package.

**There is a tool called Releng which might be better:**
https://www.codejava.net/ides/eclipse/how-to-add-copyright-license-header-for-java-source-files-in-eclipse


Eclipse provides a convenient way to automatically insert license text at the top of each newly created file. This text will be project specific as the project name must be mentioned in the license along with the project authors and a project desciption. Below is some text you can copy and paste into the code template facility of eclipse. If, for some reason, you cannot copy and paste the text below, the text is can be found in  _license-gpl3.txt_ supplied with this document. You will need to do this for each machine you use (i.e. at home, work and travelling). 
To add the license to your project, follow these steps:

. Right-click on your **_<library>_** (project) in the _Package Explorer_
. Select `Properties...`
. In the left-hand column, select `Code Templates`
. Check `Enable project specific settings`. **This is very important because the license text is project specific.**
. In the `Configure generated code and comments:` list, expand `Code` and highlight `New Java files`
. Click `Edit` and paste the license text at the top of the text in the `Pattern:` field, leaving the default references to variable unchanged.
. Edit the text within hash markers with the **_<library>_** name, description and author details.
. Click `OK`
. Click `Apply and Close`.

WARNING: Check again that you have flagged `Enable project specific settings` before proceeding to create project source code.

////
To do this efficiently, we suggest following this procedure:

. In the _doc_ directory of the project (assuming it is called _<library>_), create a Folder called _license_.

. In this folder, import https://www.gnu.org/licenses/gpl-3.0.txt[the text version of the GPL.3] and save it as _license-gpl3.txt_.

. In this folder, create a new text file (`New > Untitled Text File`) 
* copy and paste the following content in the text editor:

+
////
----
/**************************************************************************
 *  #LIB# - #SHORT_DESC#                                                 *
 *                                                                        *
 *  Copyright 2018: #AUTHOR1#, #AUTHOR2# & #AUTHOR3#                      *
 *       #EMAIL1#                                                         *
 *       #EMAIL2#                                                         *
 *       #EMAIL3#                                                         *
 *                                                                        *
 *  #LIB# is #DESCRIPTION#                                                *
 *                                                                        *
 **************************************************************************                 
 *  This file is part of #LIB# (#SHORT_DESC#).                            *
 *                                                                        *
 *  #LIB# is free software: you can redistribute it and/or modify         *
 *  it under the terms of the GNU General Public License as published by  *
 *  the Free Software Foundation, either version 3 of the License, or     *
 *  (at your option) any later version.                                   *
 *                                                                        *
 *  #LIB# is distributed in the hope that it will be useful,              *
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of        *
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
 *  GNU General Public License for more details.                          *                 
 *                                                                        *
 *  You should have received a copy of the GNU General Public License     *
 *  along with UIT.  If not, see <https://www.gnu.org/licenses/gpl.html>. *
 *                                                                        *
 **************************************************************************/
----
////
* edit the file:
** replace `\#LIB#` by _<library>_, 
** replace `\#SHORT_DESC#` by a short description (a few words more explicit than _<library>_ which may often be an acronym)
** replace `\#DESCRIPTION#` by a longer description (1-5 lines)
** replace and `\#AUTHOR__n__#` and `\#EMAIL__n__#` by the appropriate values
* save it as _license-header.txt_

You can then copy and paste the content of _license-header.txt_ at the top of every java file in your project.

Or, for convenience, you may use _LicenseManager.java_: 

. Once license_header.txt has been customised to your particular library, copy _LicenseManager.java_ into _scripts/fr.cnrs.iees.versioning_ 
. Run it (it has a `main(...)` method). It will codemagically write the license header at the top
of every java file that doesnt yet have it.

WARNING: Be careful when using _LicenseManager.java_, as (1) if you made a mistake in your license file, then
you will *have* to correct all the wrong headers by hand - there is no way to go back, and (2) if you happen
to edit the code in _LicenseManager.java_, bear in mind that *it overwrites recursively all the java files in your project* - so
any mistake can have dramatic consequences for the whole project.
////

== Writing test code

In a project the size of 3Worlds it is very important that all the code is tested. We use the standard https://junit.org/junit5/[JUnit] library for this purpose.

All test code (even the non-JUnit, custom code) must be placed in the _test_ directory to keep  production code packages clean.
[TIP]
====
Only non-abstract classes can be tested
====

. To create a JUnit test case for class _<class>_: 

. In the Package Explorer window, right-click on _<class>_ and select `New > JUnit Test Case`

. In the opening dialog box:
* tick the `New JUnit Jupiter test` check box
* specify _test_ as the source folder (it normally defaults to _src_)
* click `Next`

. Select the methods you want to create a test for and click `Finish`. The new test class should now appear in the _test_ directory
_under the same package name_ as _<class>_ in the _src_ directory. This is important as it enables testing of protected methods (i.e., it is really the _same_ package although the source directory is different for _<class>_ and its test case).

If the new class appears with an error such as `_The import org.junit.jupiter cannot be resolved_`, it is probably due to the project not being told to depend on JUnit. This is easily solved:

. In the Package Explorer, right-click on the project name, select `Build Path > Add Libraries...`

. From the list, select `JUnit`, click `Next`.

. Set the JUnit version to 5, click `Finish`

. Click `Apply and Close`. After a few seconds, the errors attached to the _test_ directory should vanish.


== Generating the javadoc

Javadoc that is no more than a restatement of the code itself (e.g. documenting the return type of a method) is frustrating to find when you are looking for explainations. Insight cannot be automated - at least not by Javadoc. To be useful, javadoc should:

* state the _objective_ of an item (typically a class or method): why was it written?

* explain its _use(s)_: often classes and methods are designed with a particular use in mind, and it is not always obvious to others what you meant. Misuses can be source of major flaws and code corruption.

* do not forget the _big picture_: what is the pattern or the strategy behind that code? This helps avoid misues. 

Remember the great loneliness of the code developer in the face of 'The Algorithm', and see the javadoc as a way to share with your fellow developers some of the genuine intuitions you have transformed into astonishing code. Take some time to be clear. Put yourself in the shoes of the reader.

This said, generating a javadoc using eclipse is particularly easy:

. Select the project. In the main menu, select `Project > Generate Javadoc...`

. In the opening dialog box, verify that the check box `Use standard doclet` is ticked.

. In the `Destination:` field, replace _/doc_ by _/javadoc_ to comply with the 3Worlds library directory structure described in <<Library organisation>>. 

. Click `Finish`. in the opening dialog box, confirm (`'Yes to All`). You should now see a huge bunch of files appearing in the _javadoc_ directory. Open _index.html_ in a browser to explore the javadoc.

== Writing documentation

A good software is useless without a good documentation (Confucius, The Book of Changes, 552 B.P.).

We recommend using https://asciidoctor.org/[asciidoctor] to produce it. Asciidoctor uses a 'lightweight markup' language to produce different document formats from a single source. It can produce https://www.w3.org/html/[html],
https://acrobat.adobe.com/us/en/acrobat/about-adobe-pdf.html[pdf], http://docs.oasis-open.org/office/v1.2/OpenDocument-v1.2.html[odf]
 or https://en.wikipedia.org/wiki/Man_page[man page] documentation; in article, book or other custom format. Having said that, Asciidoctor is still not a mature environment, so expect limitations. In paraticular, some of the editing tools are not mature and conversion to other formats is a long way from perfect. Html seems good but pdf does not appear to be of professional quality. Its great benefit is that it can reference external files and thus more easily maintain consistency between code and documentation.
 
To install Asciidoctor, (it requires https://www.ruby-lang.org/[ruby]) and also the eclipse asciidoctor editor for maximal comfort. You also need to install http://asciidoc.org/[asciidoc] because Asciidoctor is an extension of Asciidoc.

Using the asciidoctor editor integrated in eclise is easy: you just have to select your asciidoctor file (a text file with extension _.adoc_) in the `Package Explorer` window, right-click on it and select  `Open With > AsciiDoctor Editor`. The next time you open this file, you just have to double-click on it as eclipse will keep the association between that file and that editor in its preferences. The editor has a double window, one with the text and one with its 
compiled html output. Apparently, some little bug makes the output take a long time to show up the  first time you open the file. Editing the file and saving it will cause it to run properly. 

The downside of the ascii doctor plugin is that eclipse cannot do word-wrap. You can use carriage returns to get around this but it's less than satifactory and awkward if you also use an editor such as AsciidocFX or AscidocLIVE that do manage word-wrap.

Producing the exact doc files you want must be done outside eclipse in a terminal window, invoking `asciidoctor` on the command line. Type `man asciidoctor` in a terminal window to see the details of the syntax. In short:

* `asciidoctor <doc>.adoc` will produce a standard html documentation file named <doc>.html. To specify a custom output file name, use `asciidoctor -o <another-name>.html  <doc>.adoc`. Option `-v` will tell you about errors in 
the source file.

* `asciidoctor -b docbook <doc>.adoc | pandoc -t odt -o <doc>.odt` will generate a (very crude) open office document.
You need to install https://pandoc.org/[pandoc] to do this.

* Conversion to pdf usually requires an intermediate _docbook_ format file:
** `asciidoctor -b docbook -o <doc>.xml <doc>.adoc` will produce a docbook5 document.
** `a2x -f pdf <doc>.xml` will convert it to pdf. `a2x` is part of asciidoc. 

There is also a standalone https://asciidocfx.com/[Asciidoc editor]. It nicely integrates the asciidoc(tor) tool chain, but the GUI is shaky and tends to crash unpredictably.

Finally there is https://asciidoclive.com[asciidocLIVE], an online method of editiing. This site saves edits to your browser download directory in incrementally numbered files. Therefore, you will need to copy the most recent file from your brower download directory to you project at the end of an editing session.

== Managing GitLab repositories

To create a new git repo for a library:

. In the Menu bar, click on `Groups`. In the opening page, click on _threeWorlds_. This opens a page showing all the git repos / libraries existing in this group.

. Click on the green `New Project` button. In the opening page, type the relevant project name, select the relevant visibility options and click on `Create project`.

. This displays a page with all the information needed to use the new repo.

To delete a git repo:

. In the Menu bar, click on `Groups`. In the opening page, click on _threeWorlds_. This opens a page showing all the git repos / libraries existing in this group.

. In the left panel, click on `Settings` and select `Projects`. This opens a page where you can remove the projects. If you do not see the `Settings` button, ask the gitlab administrators to get the proper permissions on projects of this group. Usually, you can only delete projects that you have created yourself.

== Trouble shooting

A place to collect solutions to various problems [TODO]

Some thing above could be moved here to simplify the instructions. 

Alos one place for links to resources.

=== Ant
. Don't run more   than one Ant task at a time.

. Eclipse site:  http://www.apache.org/dist/ant/ivyde/updatesite 

=== AsciidocFX

. Download only the non-jre version to avoid conficts
. Misaligned cursor position ???
. no word wrap in ascii doc plugin




